<!DOCTYPE html>
<meta charset="utf-8">
<style>

    body {background-color: black}
.subunit {fill: #f2f2f2;
          stroke: white;}}
.subunit.mouseon {fill: blue;}
    
.stazione {fill: orange;}
.stazione-label {fill: red;}
.d3-tip
{
	line-height: 1;
	font-weight: bold;
	padding: 12px;
	background: rgba(255, 255, 255, 0.8);
  color: black;
	border-radius: 2px;
}

.d3-tip:after
{
	box-sizing: border-box;
	display: inline;
	font-size: 10px;
	width: 100%;
	line-height: 1;
	color: rgba(255, 255, 255, 0.8);
	content: "\25BC";
	position: absolute;
	text-align: center;
    font: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

.d3-tip.n:after
{
	margin: -1px 0 0 0;
	top: 100%;
	left: 0;
    font: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

.tip-text {font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 6px;}
text {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 10px;
    pointer-events:none;
    }

</style>
<body>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script>

/* JavaScript goes here. */
var width = 900,
    height = 1100;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);    
    
    
d3.json("output.json", function(error, roma) {
  if (error) return console.error(error);
  console.log(roma);
  var subunits = topojson.feature(roma, roma.objects.circoscrizioni);
    
    
  var center = d3.geo.centroid(subunits)
  console.log(center)
  var scale  = 1;
  var offset = [width/2, height/2];
  var projection = d3.geo.mercator().scale(scale)
                                    .center(center)
                                    .translate(offset);
  // create the path
  var path = d3.geo.path().projection(projection);
  
  // using the path determine the bounds of the current map and use 
  // these to determine better values for the scale and translation
  var bounds  = path.bounds(subunits);
  console.log(subunits)
  var hscale  = scale*width/2  / (bounds[1][0] - bounds[0][0]);
  var vscale  = scale*height/2 / (bounds[1][1] - bounds[0][1]);
  var scale   = (hscale < vscale) ? hscale : vscale;
  var offset  = [width - (bounds[0][0] + bounds[1][0])/2,
                    height - (bounds[0][1] + bounds[1][1])/2];    
  // new projection
  projection = d3.geo.mercator().center(center)
    .scale(scale).translate(offset);
  path = path.projection(projection);
  
    
  svg.selectAll(".subunit")
     .data(subunits.features)
     .enter().append("path")
     .attr("class", function(d) { return "subunit " + d.properties.COD_CIRCOS; })
     .attr("d", path)
     .on('mouseover', function (d) {d3.select(this)
                                       .attr('class', 'subunit mouseon');})
     .on('mouseout', function (d) {d3.select(this)
                                     .attr('class', "subunit " + d.properties.COD_CIRCOS);});

    
  var tip = d3.tip()
			.attr("class", "d3-tip")
			.offset([-40, 0])
    	    .html(function(d)
			{ return "<div class='tip-text'>Stazione: " + d.properties.Nome + "<br><br>"
                        + "La stazione Ã¨ di tipologia: "+ d.properties.Tipo + "<br><br>"
                        + "A seguire sono rappresentate le rilevazioni medie giornaliere della stazione.<br><br><br></div>"
                + "<div id='tipDiv'></div><br>" ;
			});

  svg.call(tip)
    
  var stazioni = topojson.feature(roma, roma.objects.stazioni).features
  console.log(stazioni)
  svg.selectAll('stazione')
    .data(stazioni)
    .enter()
    .append('circle')
    .attr("cx", function (d) {return projection(d.geometry.coordinates)[0]})
    .attr("cy", function (d) {return projection(d.geometry.coordinates)[1]})
    .attr('r', '0px')
    .on('mouseover', function (d,i) {tip.show(d)
                                    var tipSVG = d3.select("#tipDiv")
                                                    .append("svg")
                                                    .attr("width", 150)
                                                    .attr("height", 15 * 2)
                                    var x = d3.scale.linear()
                                                .domain([0, d3.max(50)])
                                                .range([0, 150]);
                                    
                                    var bar = tipSVG.selectAll("g")
                                                    .data([20,50])
                                                    .enter().append("g")
                                                    .attr("transform", function(d, i)
                                                    {
                                                        return "translate(0," + i * 15 + ")";
                                                    })
                                    
                                    bar.append("rect")
                                        .attr("width", 0)
                                        //.attr("height", bar)
                                        .transition()
                                        .duration(1000)
                                                    .attr("width", 25)
                                                    .attr("height", 15 - 1)
                                                    .attr("fill", function(d)
                                               {
                                          if(d === d3.max([20, 50]))
                                            {
                                              return 'red';
                                            }
                                          else
                                            {
                                              return 'blue';
                                            }
                                        });
                                    ;})
    .on('mouseout', tip.hide)
    .transition()
    .duration(2000)
    .attr('r', '7px')
    .attr("class", "stazione");
    
  svg.selectAll(".circorscrizioni-label")
    .data(subunits)
    .enter()
    .append("text")
    .attr("class", "stazione-label")
    .transition()
    .duration(2000)
    .attr("transform", function(d) { return "translate(" + projection(path.centroid(d)) + ")"; })
    .attr("dy", ".65em")
    .attr("dx", ".65em")
    .text(function(d) { return d.properties.DEN_CIRCOS; });
    
    
  
});
    
  
    

</script>